# 缓存和数据库的一致性场景题

**问题1：缓存存储空值，后面如果这个没有的商品上架了，这个商品信息更新到了MySQL, Redis里还是空值，怎么保障两块的数据是一致的？**
**问题2：更新数据库成功，删除Redis失败，Redis是脏数据，如何处理？**

## 方案一 ———— 同步删除

**核心流程**
1、更新数据库数据
2、删除缓存数据

**带来的问题**
1、并发场景下存在脏数据
2、难以收拢所有更新数据库入口
3、删除缓存失败存在脏数据

**例子**、表A存在数据 a = 1， 并发情况下可能有一下流程

时序        线程1           线程2
1                       查询数据库数据：a = 1
2       更新数据库a=2
3       删除缓存数据
4                       将数据写入缓存：a = 1（脏数据）

## 方案二 ———— 延时双删

**核心流程**
1、删除缓存数据
2、更新数据库数据
3、等待一小段时间
4、再次删除缓存数据

**带来的问题**
1、延时时间难以确认
2、延时无法绝对保障数据的一致性

**例子**、表A存在数据a = 1，并发情况下可能有以下流程

时序        线程1                   线程2                       线程3
1       删除缓存数据
2       更新主库2：a=2
3       再次删除缓存
4                              查询从库数据：a=1
5                      将数据写入缓存：a=1（脏）（毫秒级别的延时）
6                                                          数据库同步从库：a=2

## 方案三 ———— 异步监听binlog删除 + 重试  （主流方案 ）

**核心流程**
1、更新数据库
2、监听binlog删除缓存
3、缓存删除失败则通过MQ不断重试，直至删除成功

**存在问题**
1、脏数据时间窗口“较大”
2、极端场景下存在长期脏数据问题
    * binlog 抓取组件宕机
    * 拆库拆表流程

 **例子**、表A正在进行数据库拆分，当前进行到灰度切读流量阶段：部分读新库，部分读老库

 数据库拆分大致流程：增量数据同步（双写）、全量数据迁移、数据一致性校验、灰度切读、切读完毕后停写老库
 例子